R3Events
===

C# Source Generator to create Observable extension methods for events with [R3](https://github.com/Cysharp/R3), enabling seamless integration between traditional .NET events and reactive programming.

NuGet: [R3Events](https://www.nuget.org/packages/R3Events)

```
Install-Package R3Events
```

## Introduction

Events.R3 automatically generates `AsObservable()` extension methods for all public events on a target type, allowing you to seamlessly convert .NET events into R3 observables.

For example, suppose you have a class with events:

```csharp
using System.ComponentModel;

class MyControl
{
    public event EventHandler? Click;
    public event CancelEventHandler? BeforeClose;
}
```

Simply create a static partial class with the `R3Event` attribute:

```csharp
using R3Events;

[R3Event(typeof(MyControl))]
static partial class MyControlExtensions
{
}
```

Or when using C# 11 and .NET 7 or later, you can use the generic attribute syntax:

```csharp
using R3Events;

[R3Event<MyControl>]
static partial class MyControlExtensions
{
}
```

The generator will automatically create extension methods:

```csharp
// <auto-generated />
static partial class MyControlExtensions
{
    /// <summary>
    /// Returns an Observable for <c>Click</c>.
    /// </summary>
    public static Observable<Unit> ClickAsObservable(this MyControl instance, CancellationToken cancellationToken = default)
    {
        var rawObservable = Observable.FromEventHandler(
            h => instance.Click += h,
            h => instance.Click -= h,
            cancellationToken
        );
        return rawObservable.AsUnitObservable();
    }

    /// <summary>
    /// Returns an Observable for <c>BeforeClose</c>.
    /// </summary>
    public static Observable<CancelEventArgs> BeforeCloseAsObservable(this MyControl instance, CancellationToken cancellationToken = default)
    {
        var rawObservable = Observable.FromEvent<CancelEventHandler, (object?, CancelEventArgs Args)>(
            h => new CancelEventHandler((s, e) => h((s, e))),
            h => instance.BeforeClose += h,
            h => instance.BeforeClose -= h,
            cancellationToken
        );
        return rawObservable.Select(ep => ep.Args);
    }
}
```

Now you can use these events as observables:

```csharp
var control = new MyControl();

// Subscribe to Click event as Observable
control.ClickAsObservable()
    .Subscribe(_ => Console.WriteLine("Clicked!"));

// Subscribe to BeforeClose event with filtering
control.BeforeCloseAsObservable()
    .Where(args => !args.Cancel)
    .Subscribe(args => Console.WriteLine("Closing..."));
```

## Table of Contents

- [R3EventAttribute](#r3eventattribute)
- [Generated Extension Methods](#generated-extension-methods)
  - [EventHandler support](#eventhandler-support)
  - [Generic EventHandler support](#generic-eventhandler-support)
  - [Custom delegate support](#custom-delegate-support)
- [Requirements](#requirements)
- [License](#license)

## R3EventAttribute

When referencing the R3Events package, it generates an internal `R3EventAttribute`:

```csharp
namespace R3Events
{
    [AttributeUsage(AttributeTargets.Class, Inherited = false, AllowMultiple = false)]
    internal sealed class R3EventAttribute : Attribute
    {
        public R3EventAttribute(Type type) { ... }
        public Type Type { get; }
    }
}
```

When using C# 11 or later, the generator additionally creates a generic variant:

```csharp
namespace R3Events
{
    [AttributeUsage(AttributeTargets.Class, Inherited = false, AllowMultiple = false)]
    internal sealed class R3EventAttribute<T> : Attribute
    {
    }
}
```

You can attach this attribute to a `static partial class`. The generator will scan the specified target type for all public, non-static events and generate corresponding `AsObservable()` extension methods.

```csharp
// C# 10 or earlier
[R3Event(typeof(Button))]
static partial class ButtonExtensions { }

// C# 11 or later
[R3Event<Button>]
static partial class ButtonExtensions { }
```

The attributed class must be:
- `static`
- `partial`
- Not nested within another type
- Not generic

If any of these requirements are not met, the generator will emit a diagnostic error.

## Generated Extension Methods

The generator creates extension methods for all public, non-static events on the target type. The method naming convention is `{EventName}AsObservable`.

### EventHandler support

For `System.EventHandler` (non-generic), the generated observable uses `R3.Unit`:

```csharp
public event EventHandler? Click;

// Generates:
public static Observable<Unit> ClickAsObservable(
    this TargetType instance,
    CancellationToken cancellationToken = default)
```

### Generic EventHandler support

For generic event handlers like `EventHandler<T>`, the generated observable uses the event args type:

```csharp
public event EventHandler<MouseEventArgs>? MouseMove;

// Generates:
public static Observable<MouseEventArgs> MouseMoveAsObservable(
    this TargetType instance,
    CancellationToken cancellationToken = default)
```

### Custom delegate support

For custom delegates, the generator examines the delegate signature and uses the last parameter as the observable element type:

```csharp
public delegate void CustomEventHandler(object sender, CustomEventArgs e);
public event CustomEventHandler? CustomEvent;

// Generates:
public static Observable<CustomEventArgs> CustomEventAsObservable(
    this TargetType instance,
    CancellationToken cancellationToken = default)
```

## Requirements

- .NET Standard 2.0 or later
- [R3](https://github.com/Cysharp/R3) package
- C# 11 or later (for generic attribute syntax `R3Event<T>`)

```
Install-Package R3
Install-Package R3Events
```

**Important:** While R3Events does not have a package dependency on R3, the generated code calls R3 APIs (`Observable.FromEvent`, `Observable.FromEventHandler`, etc.). Therefore, you must install the R3 package in your project for the generated code to compile successfully.

## License

This library is under the MIT License.
